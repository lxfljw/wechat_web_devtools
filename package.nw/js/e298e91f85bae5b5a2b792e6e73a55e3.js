'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('fs'),b=require('path'),c=require('mkdir-p'),d=require('./72653d4b93cdd7443296229431a7aa9a.js'),e=require('./common/locales/index.js'),f=require('./5321b622f9bab971490e99e09b2389a9.js'),g=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),h=require('./1fcc6bd55b687d154a4247e57fe3011d.js'),j=require('./3e74bc0c6a5fa450386148788cc0cf44.js'),i=require('./db2217eb4cff896bdcbc50abe005058f.js'),k=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),l=require('./874074ba4ecebc4e49310ccc42243ff5.js'),m=require('./19404cae4023ed740f4fe4bce92ebf66.js'),n=require('./3bfffbe88b3d923921f851c0697974fe.js'),o=require('./3892cb9d0783075a973c350c41401370.js'),p=require('./da7c31daaf542cf1796023d8e344b98a.js'),q=()=>{},{TCB_STAGE_PREPARE:r,TCB_STAGE_GET_FUNCTION_INFO:s,TCB_STAGE_CHECK_TRIGGERS:t,TCB_STAGE_UPDATE_FUNCTION_CONFIG:u,TCB_STAGE_COMPRESS_FUNCTION_CODE:v,TCB_STAGE_WILL_UPLOAD_FUNCTION:w,TCB_STAGE_UPLOAD_FUNCTION:x,TCB_STAGE_UPLOAD_FUNCTION_TRIGGERS:y,TCB_STAGE_WAIT_FUNCTION_UPDATE:z,TCB_STAGE_WAIT_FUNCTION_UPDATE_AND_NPM:A,TCB_STAGE_UPLOAD_DONE:B}=e.config,C=(d,e)=>{for(let f,g=0,h=e.length;g<h;g++)f=b.join(d,e[g].FunctionName),a.existsSync(f)||c.sync(f)},D=async(a)=>{const b=n.getCurrentTcbInfo();let c=b.currentEnv&&b.currentEnv.namespace;if(c)return c;let d,e=(await E()(a))||[];if(0>=e.length)d=i.get(k.WINDOW_REGISTRY.CLOUD_CONSOLE),d?d.focus():a({type:g.WINDOW_SET_CLOUD,data:{console:{show:!0}}});else{if(1==e.length)return a(F(0)),c=e[0].namespace,c;d=i.get(k.WINDOW_REGISTRY.CLOUD_SCF_ACTION),d?d.focus():a({type:g.WINDOW_SET_CLOUD,data:{fnaction:{show:!0},cloudfunctionRoot:{show:!0}}})}},E=()=>{return async(a)=>{try{let b=await j.getEnvList();return a({type:g.TCB_SET_ENV_LIST,data:b.env_list}),b.env_list}catch(b){a({type:g.INFO_SHOW_ERROR,data:{message:b.toString()}})}}},F=(a)=>{return{type:g.TCB_SELECT_ENV,data:a}},G=(a)=>{return async(c,d)=>{try{let e=await D(c,d);if(!e)return;const h=d(),i=h.project.current||{},k=b.join(i.projectpath,i.cloudfunctionRoot);a.showTips&&c(N({show:!0,title:'\u6B63\u5728\u540C\u6B65\u4E91\u51FD\u6570\u5217\u8868',content:'',showCancel:!1,showLoading:!0}));let l=`${Date.now()}${Math.random()}`,m=await j.getTcbFuncList({namespace:e,pageIndex:0,pageSize:f.FUNC_LIST_PAGE_SIZE}),n=[].concat(m.Functions);if(a.writeFile&&C(k,m.Functions),c({type:g.TCB_SET_SCF_LIST,data:{list:m.Functions,pageIndex:0,total:m.total,namespace:e,updateKey:l}}),m.total>f.FUNC_LIST_PAGE_SIZE){let b=parseInt((m.total-1)/f.FUNC_LIST_PAGE_SIZE);for(let d,h=1;h<b;h++)d=await j.getTcbFuncList({namespace:e,pageIndex:h,pageSize:f.FUNC_LIST_PAGE_SIZE}),n=n.concat(d.Functions),a.writeFile&&C(k,d.Functions),c({type:g.TCB_SET_SCF_LIST,data:{list:d.Functions,pageIndex:h,total:m.total,namespace:e,updateKey:l}})}return c({type:g.TCB_CLEAN_SCF_LIST,data:{namespace:e,updateKey:l}}),a.showTips&&c(N({show:!0,title:'\u540C\u6B65\u4E91\u51FD\u6570\u5217\u8868\u6210\u529F',content:'',showCancel:!1,showLoading:!1})),n}catch(b){a.showTips&&c(N({show:!0,title:'\u540C\u6B65\u4E91\u51FD\u6570\u5217\u8868\u5931\u8D25',content:b.toString(),showCancel:!1,showLoading:!1}))}}},H=(a)=>{return{type:g.TCB_CONSOLE_COMMAND,data:a}},I=(a)=>{return 1024>a?`${a} B`:1048576>a?`${(a/1024).toFixed(1)} KB`:`${(a/1024/1024).toFixed(1)} MB`},J=(a)=>{let b=[];return a.hasOwnProperty('packSize')&&b.push(`上传包大小：${I(a.packSize)}`),a.hasOwnProperty('filesCount')&&b.push(`文件数量：${a.filesCount}`),b.join('\uFF0C')},K=async(a)=>{return new Promise(async(b,c)=>{let e=!1;const{namespace:f,functionName:g,onStatusUpdate:h=q,maxWaitTimeout:i=900000}=a,k=setTimeout(()=>{e||(e=!0,c(new Error(`timeout waiting for function to deploy`)))},i);try{let a='';for(const c=+new Date;!e&&+new Date-c<i;){const c=await j.getTcbFuncInfo({namespace:f,functionName:g});switch(global.appConfig.isDev&&console.warn('info for func',g,c),c.Status){case m.FUNCTION_STATUS.Creating:{a!==c.Status&&h(c.Status);break}case m.FUNCTION_STATUS.Updating:{a!==c.Status&&h(c.Status);break}case m.FUNCTION_STATUS.CreateFailed:throw new Error(`创建云函数失败：${c.StatusDesc}`);case m.FUNCTION_STATUS.UpdateFailed:throw new Error(`更新云函数失败：${c.StatusDesc}`);case m.FUNCTION_STATUS.Active:{e=!0,b();break}}}}catch(a){global.appConfig.isDev&&(console.trace(),console.error(a));try{d.error(`upload ${f} ${g} failed: `,'string'==typeof a?a:JSON.stringify(a))}catch(a){d.error(`upload ${f} ${g} failed: `,a.toString())}clearTimeout(k),c(a)}})},L=(a)=>{return async(c,d)=>{const e=await D(c,d);if(!e)return;const{dirPath:f,showTips:g,runtime:h,syncFunctions:i,createFunction:k,installDependency:l}=a,n=b.basename(f);let o=r;try{if(!k){g&&(o=s,c(N({show:!0,title:`正在获取云函数 ${n} 的配置信息`,content:'',showCancel:!1,showLoading:!0})));const a=await j.getTcbFuncInfo({namespace:e,functionName:n});let b=l?'TRUE':'FALSE';if(p(l?'tcb_upload_func_install_dependency':'tcb_upload_func_full',!0),b!==a.InstallDependency){g&&(o=u,c(N({show:!0,title:`正在更新云函数 ${n} 的配置`,content:'',showCancel:!1,showLoading:!0})));await j.updateTcbFuncConfig({namespace:e,functionName:n,config:{InstallDependency:b}})}}g&&(o=w,c(N({show:!0,title:`正在${k?'\u521B\u5EFA':'\u4E0A\u4F20'} ${n}`,content:'',showCancel:!1,showLoading:!0})));const a=await j.uploadTcbFunc({functionName:n,dirPath:f,runtime:h,namespace:e,installDependency:l,onStatusUpdate:(b)=>{if(g){let d='';switch(b){case m.IDE_UPLOAD_STATUS.COMPRESSING:{o=v,d=`正在压缩打包云函数 ${n} 代码 ...`;break}case m.IDE_UPLOAD_STATUS.UPLOADING:{o=x,d=`正在${k?'\u521B\u5EFA':'\u4E0A\u4F20'} ${n}`;break}}c(N({show:!0,title:d,content:J(a),showCancel:!1,showLoading:!0}))}}});if(g){const b=`上传 ${n} 成功 ...`,d={show:!0,title:b,content:J(a),showCancel:!1,showLoading:!0};c(N(d)),o=l?A:z,await K({namespace:e,functionName:n,onStatusUpdate:(a)=>{let e='';switch(a){case m.FUNCTION_STATUS.Creating:{e=`${b}，正在创建云函数 ...`;break}case m.FUNCTION_STATUS.Updating:{e=l?`${b}，正在更新云函数及云端安装依赖 ...`:`${b}，正在更新云函数 ...`;break}}c(N(_extends({},d,{title:e})))}}),o=B,c(N(_extends({},d,{title:`上传并部署 ${n} 完成`,showLoading:!1})))}i&&G({showTips:!1,writeFile:!1})(c,d)}catch(a){console.error('uploadTcbFunc fail',a),g&&c(N({show:!0,title:`${k?'\u521B\u5EFA':'\u4E0A\u4F20'} ${n} 在${o}阶段失败`,content:a.toString(),showCancel:!1,showLoading:!1}))}}},M=(d)=>{return async(f,e)=>{const h=d.namespace||(await D(f,e));if(h)try{d.showTips&&f(N({show:!0,title:`正在下载 ${d.functionName}`,content:'',showCancel:!1,showLoading:!0}));let e=await l.getFunctionData({functionName:d.functionName,forceUpdate:!0,namespace:h});if(d.writeFile)for(var i in e){let f=b.join(d.dirPath,i),g=b.dirname(f);c.sync(g),a.writeFileSync(f,e[i])}f({type:g.TCB_SET_FILE,data:{functionName:d.functionName,fileList:Object.keys(e),namespace:h}}),d.showTips&&f(N({show:!0,title:'\u4E0B\u8F7D\u6210\u529F',content:'',showCancel:!1,showLoading:!1}))}catch(a){d.showTips&&f(N({show:!0,title:'\u4E0B\u8F7D\u5931\u8D25',content:a.toString(),showCancel:!1,showLoading:!1}))}}},N=(a)=>{return{type:g.TCB_SET_LOADING,data:a}};module.exports={getEnvList:E,selectEnv:F,getTcbFuncList:G,uploadTcbFunc:L,consoleCommand:H,showActionMsg:(a)=>{return{type:g.TCB_SCF_INFO,data:{show:!0,message:a}}},setConfirmInfo:(a)=>{return{type:g.TCB_SCF_INFO,data:a}},showConsoleAddSCF:()=>{return async(a,b)=>{const c=n.getCurrentTcbInfo(),d=await D(a,b);if(d){let b=i.get(k.WINDOW_REGISTRY.CLOUD_CONSOLE);b?b.focus():a({type:g.WINDOW_SET_CLOUD,data:{console:{show:!0}}}),a(H({command:'SHOW_CREATE_SCF',data:{namespace:d,envId:c.currentEnv&&c.currentEnv.id}}))}}},downloadTcbFunc:M,downloadAllTcbFunc:(d)=>{return async(f,e)=>{const h=e(),i=h.project.current.cloudfunctionRoot,j=await D(f,e);if(j){d.showTips&&f(N({show:!0,title:'\u6B63\u5728\u4E0B\u8F7D\u8BF7\u7A0D\u7B49',content:'',showCancel:!1,showLoading:!0}));try{const h=(await G(d)(f,e))||[];let m=[];for(let e,n=0,o=h.length;n<o;n++){e=h[n],d.showTips&&f(N({show:!0,title:`正在下载 ${e.FunctionName}`,content:'',showCancel:!1,showLoading:!0}));try{let h=await l.getFunctionData({functionName:e.FunctionName,forceUpdate:d.forceUpdate,namespace:j});if(d.writeFile){let d=b.join(i,e.FunctionName);for(var k in h){let e=b.join(d,k),f=b.dirname(e);c.sync(f),a.writeFileSync(e,h[k])}}f({type:g.TCB_SET_FILE,data:{functionName:e.FunctionName,fileList:Object.keys(h),namespace:j}})}catch(a){m.push(a.toString()),d.showTips&&f(N({show:!0,title:'\u90E8\u5206\u4E0B\u8F7D\u5931\u8D25',content:m.join('\n'),showCancel:!1,showLoading:!0}))}}d.showTips&&f(N({show:!0,title:'\u4E0B\u8F7D\u6210\u529F',content:'',showCancel:!1,showLoading:!1}))}catch(a){d.showTips&&f(N({show:!0,title:'\u4E0B\u8F7D\u5931\u8D25',content:a.toString(),showCancel:!1,showLoading:!1}))}}}},setLoading:N,uploadTcbFunctions:(a)=>{return async(b,c)=>{const d=a.dirPaths;for(let e,f=0;f<d.length;f++)e=d[f],await L({showTips:a.showTips,syncFunctions:!1,dirPath:e})(b,c);G({showTips:!1,writeFile:!1})(b,c)}},uploadTcbFuncTriggers:(c)=>{return async(d,e)=>{const f=await D(d,e);if(!f)return;const{dirPath:g,showTips:h,syncFunctions:i}=c,k=b.basename(g);let l=r;try{h&&(l=t,d(N({show:!0,title:`正在获取云函数 ${k} 的本地触发器配置信息`,content:'',showCancel:!1,showLoading:!0})));const c=b.join(g,'config.json');if(!a.existsSync(c))throw new Error(`未找到云函数配置文件 config.json`);let e=a.readFileSync(c,'utf8');try{e=JSON.parse(e)}catch(a){throw new Error(`JSON 解析 config.json 失败，请确认文件是标准 JSON 格式, ${a}`)}if(!e.triggers||!Array.isArray(e.triggers))throw new Error(`请确认 config.json 中包含合法的 triggers 字段`);h&&(l=y,d(N({show:!0,title:`正在上传 ${k} 触发器`,content:'',showCancel:!1,showLoading:!0}))),await j.batchCreateTcbFuncTriggers({namespace:f,functionName:k,count:e.triggers.length,triggers:e.triggers.map((a,b)=>{if('Object'===!Object.prototype.toString.call(a).slice(8,-1))throw new Error(`triggers[${b}] 定义必须是合法对象`);if(!a.name)throw new Error(`triggers[${b}] 缺少必填参数 name`);if(!a.type)throw new Error(`triggers[${b}] 缺少必填参数 type`);switch(a.type){case'timer':{if(!a.config)throw new Error(`triggers[${b}] 缺少必填参数 config`);break}default:}return{TriggerName:a.name,Type:a.type,TriggerDesc:a.config}})}),h&&(l=B,d(N({show:!0,title:`上传 ${k} 触发器完成`,content:'',showCancel:!1,showLoading:!1})))}catch(a){console.error('uploadTcbFuncTriggers fail',a),h&&d(N({show:!0,title:`上传 ${k} 触发器在${l}阶段失败`,content:a.toString(),showCancel:!1,showLoading:!1}))}}},deleteTcbFuncTriggers:(a)=>{return async(c,d)=>{const{dirPath:e,showTips:f}=a;try{const a=await D(c,d);if(!a)return;const g=b.basename(e);f&&c(N({show:!0,title:`正在删除 ${g} 触发器`,content:'',showCancel:!1,showLoading:!0})),await j.batchCreateTcbFuncTriggers({namespace:a,functionName:g,count:0,triggers:[]}),f&&c(N({show:!0,title:`删除 ${g} 触发器成功`,content:'',showCancel:!1,showLoading:!1}))}catch(a){console.error('deleteTcbFuncTriggers fail',a),f&&c(N({show:!0,title:`删除 ${functionName} 触发器失败`,content:a.toString(),showCancel:!1,showLoading:!1}))}}},downloadTcbFunctions:(a)=>{return async(c,d)=>{for(let e,f=0;f<a.functionNames.length;f++)e=a.functionNames[f],await M(_extends({},a,{dirPath:b.join(a.dirPath,e),functionName:e}))(c,d)}},setCurrentEnv:(a)=>{return async(b)=>{const c=n.getCurrentTcbInfo();let d=c.envList;if(0>=d.length){let a=await j.getEnvList();b({type:g.TCB_SET_SCF_LIST,data:a.env_list}),d=a.env_list}const e=d.findIndex((b)=>{return b.namespace==a});-1!=e&&b(F(e))}}}}(require('lazyload'),require);