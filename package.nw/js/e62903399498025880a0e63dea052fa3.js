'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){function a(a){function b(a){return{1:'up',2:'up-mirrored',3:'down',4:'down-mirrored',5:'left-mirrored',6:'right',7:'right-mirrored',8:'left'}[a]||'up'}const c=new Uint8Array(a).buffer,d=new DataView(c);if(65496!=d.getUint16(0,!1))return b(-2);const e=d.byteLength;for(let c=2;c<e;){const a=d.getUint16(c,!1);if(c+=2,65505==a){if(1165519206!=d.getUint32(c+=2,!1))return b(-1);const a=18761==d.getUint16(c+=6,!1);c+=d.getUint32(c+4,a);const e=d.getUint16(c,a);c+=2;for(let f=0;f<e;f++)if(274==d.getUint16(c+12*f,a))return b(d.getUint16(c+12*f+8,a))}else if(65280!=(65280&a))break;else c+=d.getUint16(c,!1)}return b(-1)}async function b(a){if(global.autoTest)return{success:!1};const b=global.windowMap.get('MAIN').window,c=document.createElement('input');return c.style.display='none',c.setAttribute('type','file'),a.accept&&c.setAttribute('accept',a.accept),a.multiple&&c.setAttribute('multiple','multiple'),b.document.body.appendChild(c),c.click(),n('chooseFile'),new Promise((a)=>{c.addEventListener('change',(d)=>{b.document.body.removeChild(c),o('chooseFile'),a({success:!0,event:d})}),c.addEventListener('cancel',(d)=>{b.document.body.removeChild(c),o('chooseFile'),a({success:!1,event:d})})})}async function c(a){if(global.autoTest)return{success:!1};const b=global.windowMap.get('MAIN').window.document.body,c=document.createElement('input');return c.style.display='none',c.setAttribute('nwsaveas',a.name||''),c.setAttribute('type','file'),a.accept&&c.setAttribute('accept',a.accept),b.appendChild(c),c.click(),new Promise((a)=>{c.addEventListener('change',(d)=>{b.removeChild(c),a({success:!0,event:d})}),c.addEventListener('cancel',(d)=>{b.removeChild(c),a({success:!1,event:d})})})}function d(a){const b=j.lookup(a);return 0<=b.indexOf('video/')}async function e(a){return new Promise((b,c)=>{const d=document.createElement('video');d.addEventListener('error',(a)=>{console.error(a);try{c(a.path[0].error.message)}catch(b){c(a)}}),d.addEventListener('loadedmetadata',()=>{d.play();let a=parseFloat(d.duration);a=isNaN(a)?0:a;const c=Math.min(100*a,500);setTimeout(()=>{const a=document.createElement('canvas');a.width=d.videoWidth,a.height=d.videoHeight,a.getContext('2d').drawImage(d,0,0,a.width,a.height);const c=a.toDataURL().replace(/^data:image\/(jpg|png);base64,/,''),e=l.getCurrent(),f=p.saveBase64DataToFile(e,c,'.jpg');let g='';f.error||(g=f.tempFilePath),b({duration:d.duration,width:d.videoWidth,height:d.videoHeight,thumbTempFilePath:g})},c)}),d.setAttribute('src',a.replace(/^https?:\/\//,`$&127.0.0.1:${global.proxyPort}/`)),d.defaultMuted=!0})}async function f(a,c){const d=c.args||{},e=c.api;let f=(d.type||'').toLowerCase();const g=parseInt(d.count,10)||1;0>['file','video','image'].findIndex((a)=>a===f)&&(f='file');let k='*/*';'video'===f?k='video/*':'image'===f&&(k='image/*');const m=await b({accept:k,multiple:1<g});if(m.success){const a=m.event,b=[],d=a.target.value.split(';');d.forEach((a)=>{const d={name:h.basename(a)},e=h.extname(a);try{const b=i.lstatSync(a);d.size=b.size}catch(a){return{errMsg:`${c.api}:fail ${a}`}}const f=l.getCurrent();d.path=p.copyFileToTemp(f,a,e);const g=(j.lookup(a)||'').toLowerCase();let k='file';0<=g.indexOf('video/')?k='video':0<=g.indexOf('image/')&&(k='image'),d.type=k,b.push(d)});const e={errMsg:`${c.api}:ok`,tempFiles:b.slice(0,g)};return e}return{errMsg:`${c.api}:cancel`}}var g=Number.isInteger;const h=require('path'),i=require('fs'),j=require('mime-types'),k=require('./0634ee2ebd3e560d9d4804ecc960160f.js'),l=require('./3bfffbe88b3d923921f851c0697974fe.js'),m=require('./libs/imagesize.js'),{enterBackground:n,enterForeground:o}=require('./a3959bb900db9f65ed2e9c5dfa6977b7.js'),p=require('./f6cbcecf6ed9f533f6a506310d8f07b6.js');module.exports={chooseFile:f,chooseVideo:async function(a,c){const d=c.args,f=await b({accept:'video/*'});if(f.success){const a=f.event,b=a.target.value.split(';'),d=[],g=b[0],j=h.extname(g),k=l.getCurrent();d.push(p.copyFileToTemp(k,g,j));const m=i.statSync(g),n=await e(d[0]);return{errMsg:`${c.api}:ok`,tempFilePath:d[0],size:m.size,duration:n.duration,width:n.width,height:n.height,thumbTempFilePath:n.thumbTempFilePath}}return{errMsg:`${c.api}:cancel`}},chooseImage:async function(a,c){const d=c.args,e=g(d.count)&&9>=d.count&&1<=d.count?d.count:9,f=await b({accept:'image/*',multiple:1<e});if(f.success){const a=f.event,b=[],d=[];let g=a.target.value.split(';');g=g.slice(0,e),g.forEach((a)=>{const c=h.extname(a);try{const b=i.lstatSync(a);d.push(b.size)}catch(a){return}const e=l.getCurrent();b.push(p.copyFileToTemp(e,a,c))});const j={errMsg:`${c.api}:ok`,tempFilePaths:b};return 1002000<=l.getLibVersionNumber()&&(j.tempFileSizes=d),j}return{errMsg:`${c.api}:cancel`}},chooseMessageFile:f,previewImage:async function(a,b){return a({type:k.SIMULATOR_SET_PREVIEW_IMAGE,data:{show:!0,urls:b.args.urls||[],current:b.args.current||''}}),{errMsg:`${b.api}:ok`}},getImageInfo:async function(b,c){const d=c.args.src;if(!d)return{errMsg:`${c.api}:fail file not found`};const e=l.getCurrent(),f=p.getFileRealPath(d,e),g=f.fileRealPath;return i.existsSync(g)?new Promise((b)=>{const d=i.createReadStream(g);m(d,function(d,e){d?b({errMsg:`${c.api}:fail ${d.toString()}`}):b({errMsg:`${c.api}:ok`,width:e.width,height:e.height,type:e.format,orientation:a(i.readFileSync(g))})})}):{errMsg:`${c.api}:fail file not found`}},chooseMedia:async function(a,c){const f=c.args||{},j=c.api,k=g(f.count)&&9>=f.count&&1<=f.count?f.count:9,m=f.mediaType||['video','image'],n=[];let o=!1;0<=m.indexOf('video')&&n.push('video/*'),0<=m.indexOf('image')&&(o=!0,n.push('image/*'));const q=await b({accept:n.join(','),multiple:!!o&&1<k});if(q.success){const a=q.event;let b=a.target.value.split(';');b=b.slice(0,k);let c='';b.forEach((a)=>{!c&&d(a)&&(c=a)});const f=[],g=l.getCurrent();if(c){const a=c,b=h.extname(a),d=i.statSync(a),f=p.copyFileToTemp(g,a,b);let k;try{k=await e(f)}catch(a){const b=a.toString&&a.toString()||`${a}`;return console.warn(b),{errMsg:`${j}:fail ${b}`}}const l=_extends({tempFilePath:f,size:d.size},k);return{errMsg:`${j}:ok`,type:'video',tempFiles:[l]}}return b.forEach((a)=>{const b=h.extname(a),c=i.statSync(a);f.push({tempFilePath:p.copyFileToTemp(g,a,b),size:c.size})}),{errMsg:`${j}:ok`,type:'image',tempFiles:f}}return{errMsg:`${j}:cancel`}},saveVideoToPhotosAlbum:async function(a,b){const{api:d,args:e}=b,f=e.filePath,g=p.getFileRealPath(f),j=g.fileRealPath;if(g.error)return{errMsg:`${d}:fail ${error.reason||'file not found'}`};if(g.type!==p.TMP&&g.type!==p.STORE&&g.type!==p.USR&&g.type!==p.PACKAGE||!i.existsSync(j))return{errMsg:`${d}:fail file not found`};const k=h.basename(j),l=await c({name:k,accept:'video/*'});if(l.success){const a=l.event,b=a.target.value;return i.writeFileSync(b,i.readFileSync(j)),{errMsg:`${d}:ok`}}return{errMsg:`${d}:cancel`}},saveImageToPhotosAlbum:async function(a,b){const{api:d,args:e}=b,f=e.filePath,g=p.getFileRealPath(f),j=g.fileRealPath;if(g.type===p.USR&&g.type===p.TMP&&g.type===p.STORE&&g.type===p.PACKAGE||!i.existsSync(j)||!i.statSync(j).isFile())return{errMsg:`${d}:fail file not found`};const k=h.basename(j),l=await c({name:k,accept:'image/*'});if(l.success){const a=l.event,b=a.target.value;return i.writeFileSync(b,i.readFileSync(j)),{errMsg:`${d}:ok`}}return{errMsg:`${d}:cancel`}}}}(require('lazyload'),require);