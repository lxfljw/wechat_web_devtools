'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){const a=require('fs'),b=require('path'),c=require('qrcode-terminal'),d=require('./84858de8a097c9cf84ff2c2e3d86e2a9.js'),e=require('./42191d95974f14b18961c9f2c730464e.js'),f=require('./cc2c2970ff81ae4a83123e81ee123da2.js'),g=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),h=require('./d28a711224425b00101635efe1034c99.js'),i=require('./6242f55dbdfe53c2f07b7a51568311f2.js'),j=require('./f0466135fc8b3a662084784e5f4ac792.js'),k=require('./15ba1827c7f6564a45df6bd44da3a977.js'),l=require('./9fdd4ac31a05c27355910f0d74accd4c.js'),m=require('./5eb00762b104199e0cf0af7efbe591da.js'),n=require('./6b0bd6bb0fa981d25d4c0fb4b85edbab.js'),o=require('./36244f5aa8a25574083d64e28953b466.js'),p=require('./78294f0b5b50fc38258d7028553744ef.js'),q=require('./5719b6ded53098ffd9e848abcac30153.js'),r=require('./da7c31daaf542cf1796023d8e344b98a.js'),s=require('./common/locales/index.js'),t=require('./1dea83a77e99a7c94f6b6f01f5c175b0.js'),u={network:{RequestDomain:[],WsRequestDomain:[],UploadDomain:[],DownloadDomain:[]},setting:_extends({},i.setting)},v=({test:k=!0,projectpath:b,version:d,desc:e,appid:f,format:r='image',qroutput:g,infoOutput:h,compileCondition:i}={})=>new Promise(async(f,u)=>{let v;if(v=p.checkProjectPath(b),v.error)return u(v.error);if(h&&(v=p.checkInfoOutput(h),v.error))return u(v.error);if(k)if(!r)r='image';else if(v=p.checkFormat(r),v.error)return u(v.error);if(k&&g&&(v=p.checkQROutput(g),v.error))return u(v.error);if(!k&&(v=p.checkVersion(d),v.error))return u(v.error);let w;if(v=p.checkProjectConfigJSON(b),v.error)return u(v.error);if(w=v.config,!w.appid)return u(q.ERROR.NOT_FOUND_IN_PROJECT_CONFIG_JSON('appid'));let x;try{x=await m.getAppInfo(w.appid)}catch(a){u(a)}try{const m=await o.getProject(x,w,b),p={test:k,tempProject:m,onFilesIgnored(){}};if(!k)p.version=d,p.desc=e;else if(i){const a=JSON.parse(i);if(a&&a.pathName)p.page=a.pathName;else{const a=await t(m);p.page=a.pages[0]}p.query=a?a.query:'',m.attr.gameApp&&(p.query=a?a.query:'')}else if(m.compileType&&w.condiction){const a=m.compileType,b=w.condiction[a]||{},c=b.list&&b.list[b.current];if(a==l.search)c&&(p.searchQuery=c.customQuery||c.query,p.boxQI=c.customQuery?'':c.boxQI);else if(a==l.weapp){if(c&&c.pathName)p.page=c.pathName;else{const a=await t(m);p.page=a.pages[0]}p.query=c?c.query:''}m.attr.gameApp&&(p.query=c?c.query:'')}else p.page=void 0,p.query='';j(p).then(async(b)=>{if(h){const c={size:{total:+(b.wxpkg_size/1024).toFixed(2),packages:b.subpackage_info&&b.subpackage_info.sort((a,b)=>a.name<b.name).map((a)=>{return'__APP__'===a.name?{name:'main',size:+(a.size/1024).toFixed(2)}:{name:a.name,size:+(a.size/1024).toFixed(2)}})||void 0}};a.writeFileSync(h,JSON.stringify(c,null,2),'utf8')}if(k){const d=b.qrcode_img;if('terminal'==r)try{const b=await n.decodeQRCode(new Buffer(d,'base64'),w.appid);c.generate(b,(b)=>{g&&a.writeFileSync(g,b),f({qrcode:b,encoding:'utf8'})})}catch(a){u(q.ERROR.GENERIC_ERROR(a.toString()))}else'image'==r?(g&&a.writeFileSync(g,new Buffer(d,'base64')),f({qrcode:new Buffer(d,'base64'),encoding:null})):'base64'==r&&(g&&a.writeFileSync(g,d,'utf8'),f({qrcode:d,encoding:'utf8'}))}else{const a=b.baseresponse;if(a){const b=a.errcode;0===b?f():u(q.ERROR.GENERIC_ERROR(s.config.UNKNOWN_UPLOAD_RESULT))}else u(q.ERROR.GENERIC_ERROR(s.config.UNKNOWN_UPLOAD_RESULT))}global.CLI.project=null}).catch((a)=>{global.CLI.project=null,u(q.ERROR.GENERIC_ERROR(a.toString()))})}catch(a){global.CLI.project=null,u(q.ERROR.GENERIC_ERROR(a.toString()))}});module.exports={handleUpload:v,registerHandlers:(a)=>{a.get('/preview',async(a,b)=>{try{const c=decodeURIComponent(a.mQuery.projectpath||''),d=decodeURIComponent(a.mQuery.format||''),e=decodeURIComponent(a.mQuery.qroutput||''),f=decodeURIComponent(a.mQuery.infooutput||''),g=decodeURIComponent(a.mQuery.compilecondition||''),h=decodeURIComponent(a.mQuery.cli||''),i=decodeURIComponent(a.mQuery.from||'');h?r('cli_preview',null,null,i?{engine_from:i}:null):r('http_preview',null,null,i?{engine_from:i}:null);const j=await v({projectpath:c,format:d,qroutput:e,infoOutput:f,compileCondition:g,test:!0});b.statusCode=200,b.end(j.qrcode,j.encoding)}catch(a){if(a){b.statusCode=400;try{JSON.parse(a)&&b.writeHead(b.statusCode,{"Content-Type":'application/json;  charset=utf-8'})}catch(a){}b.end(a)}else b.writeHead(500,{"Content-Type":'application/json;  charset=utf-8'}),b.end()}}),a.get('/upload',async(a,b)=>{try{const c=decodeURIComponent(a.mQuery.projectpath||''),d=decodeURIComponent(a.mQuery.version||''),e=decodeURIComponent(a.mQuery.desc||''),f=decodeURIComponent(a.mQuery.format||''),g=decodeURIComponent(a.mQuery.qroutput||''),h=decodeURIComponent(a.mQuery.infooutput||''),i=decodeURIComponent(a.mQuery.cli||''),j=decodeURIComponent(a.mQuery.from||'');i?r('cli_upload',null,null,j?{engine_from:j}:null):r('http_upload',null,null,j?{engine_from:j}:null);await v({projectpath:c,version:d,desc:e,format:f,qroutput:g,infoOutput:h,test:!1});b.statusCode=200,b.end()}catch(a){if(a){b.statusCode=a.statusCode||400;try{JSON.parse(a)&&b.writeHead(b.statusCode,{"Content-Type":'application/json;  charset=utf-8'})}catch(a){}b.end(a.toString())}else b.writeHead(500,{"Content-Type":'application/json;  charset=utf-8'}),b.end(q.ERROR.GENERIC_ERROR())}})}}}(require('lazyload'),require);