'use strict';!function(require,directRequire){function a(b){if(n){const c=p.get(b);if(c){if(c.heartbeatPendingCount>s)return d.info(`unresponsive client window (id: ${b}) will be disconnected`),v(b),u({id:b,projectid:c.projectid,fromAction:!0}),p.delete(b),void o.delete(b);c.heartbeatPendingCount++,c.timeoutId=setTimeout(a.bind(this,b),r),n.postMessage({type:e.EVENT_HEARTBEAT,id:b})}}}function b(b){const{data:c}=b;switch(c.type){case e.EVENT_HEARTBEAT:{if(c.id){const a=p.get(c.id);a&&a.heartbeatPendingCount--}break}case e.EVENT_DEV_WINDOW_OPENED:{c.id&&(p.set(c.id,{[e.INIT_TIME]:+new Date,id:c.id,projectid:c.projectid,heartbeatPendingCount:0}),o.delete(c.projectid),w(),a(c.id)),q.emit(e.EVENT_DEV_WINDOW_OPENED,c.id),q.emit(`${e.EVENT_DEV_WINDOW_OPENED}-${c.id}`,c.id),q.emit(`${e.EVENT_DEV_WINDOW_OPENED}-${c.projectid}`,c.projectid);break}case e.EVENT_DEV_WINDOW_CLOSE:{u(c);break}case e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE:{p.has(c.id)?c[e.CLI_PORT]?(p.get(c.id)[e.CLI_PORT]=c[e.CLI_PORT],q.emit(e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE,c.id,c.projectid,c[e.CLI_PORT]),q.emit(`${e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE}-${c.id}`,c.id,c.projectid,c[e.CLI_PORT]),q.emit(`${e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE}-${c.projectid}`,c.id,c.projectid,c[e.CLI_PORT])):d.info(`server.sync.js: a dev window notify the update of cli port without an cliPort argument, id: ${c.id}`):d.info(`server.sync.js: a dev window, whose id is not present in client window map, notify the update of cli port: ${c.id}`);break}case e.CHANGE_LOCALE:{m.getSourceLocale()!==c.locale&&m.setLocale(c.locale);break}}}const c=require('events'),d=require('./72653d4b93cdd7443296229431a7aa9a.js'),e=require('./09060286633d09fb81fefc8ff1294dd7.js'),f=require('./84b183688a46c9e2626d3e6f83365e13.js'),g=require('./bc78839ccca8df9e5ceeb7fae11b7be2.js'),h=require('./cc2c2970ff81ae4a83123e81ee123da2.js'),i=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),j=require('./205e69607c4b60711b15f5ac95b40ce4.js'),k=require('./5451dfc4d939398d913dc724d952b02b.js'),l='darwin'===process.platform,m=require('./common/locales/index.js');let n;const o=new Set,p=new Map,q=new c,r=6000,s=10,t=()=>{global.Win.show(),l&&k.init(global.Win)},u=(a)=>{p.has(a.id)?(a.id===j.getCurrentBrowsingContext()&&j.setCurrentBrowsingContext(j.getMainWindowHandle()),p.delete(a.id),d.info(`dev window with id ${a.id} closed, cur ctx: ${j.getCurrentBrowsingContext()}`)):d.info(`server.sync.js: a dev window whose id is not present in client window map is closed: ${a.id}`),q.emit(e.EVENT_DEV_WINDOW_CLOSE,a.id),0===p.size&&(l?a.fromAction?(g.dispatch(h.selectDevType(i.DEV_TYPE.MINI_PROGRAM)),t()):(t(),global.Win.hide()):a.fromAction?(g.dispatch(h.selectDevType(i.DEV_TYPE.MINI_PROGRAM)),t()):global.contentDocument.hidden&&(0===o.size?f.quit():setTimeout(()=>{0===p.size&&global.contentDocument.hidden&&f.quit()},5e3)))},v=(a)=>{return!!n&&(n.postMessage({type:e.COMMAND_DEV_WINDOW_CLOSE,id:a}),!0)},w=()=>{n&&n.postMessage({type:e.EVENT_SVR_WINDOW_CLI_PORT_UPDATE,cliPort:global.cliPort})};module.exports={init:()=>{n=new BroadcastChannel(e.BROADCAST_CHANNEL_NAME),n.onmessage=b,q.on(e.EVENT_DEV_WINDOW_OPENED,()=>{global.Win.hide()})},once:(a)=>new Promise((b)=>{q.once(a,b)}),onceWindowOpen:({id:a,projectid:b}={})=>new Promise((c)=>{a||(a=b),q.once(`${e.EVENT_DEV_WINDOW_OPENED}-${a}`,c)}),onceCliPortUpdate:({id:a,projectid:b}={})=>new Promise((c)=>{a||(a=b),q.once(`${e.EVENT_DEV_WINDOW_CLI_PORT_UPDATE}-${a}`,(a,b,d)=>{c(d)})}),pendingOpenWindows:o,clientWindows:p,serverSyncEvents:q,closeDevWindow:v,closeAllDevWindows:()=>{return!!n&&(n.postMessage({type:e.COMMAND_DEV_WINDOW_CLOSE_ALL}),!0)},notifyCliPortUpdate:w,getClientIdByProjectId:function(a){for(const[b,c]of p)if(c&&c.projectid===a)return b;return null},notifyChangeLocale:(a)=>{n&&n.postMessage({type:e.CHANGE_LOCALE,locale:a})}}}(require('lazyload'),require);